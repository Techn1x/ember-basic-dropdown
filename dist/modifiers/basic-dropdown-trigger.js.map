{"version":3,"file":"basic-dropdown-trigger.js","sources":["../../src/modifiers/basic-dropdown-trigger.ts"],"sourcesContent":["import Modifier from 'ember-modifier';\nimport type { ArgsFor, PositionalArgs, NamedArgs } from 'ember-modifier';\nimport { assert } from '@ember/debug';\nimport { action } from '@ember/object';\nimport { isDestroyed, registerDestructor } from '@ember/destroyable';\nimport hasMoved from '../utils/has-moved.ts';\nimport type { Dropdown } from '../components/basic-dropdown';\nimport type Owner from '@ember/owner';\n\ninterface Signature {\n  Element: HTMLElement;\n  Args: {\n    Named: {\n      dropdown: Dropdown;\n      eventType?: 'click' | 'mousedown';\n      stopPropagation?: boolean;\n      [named: string]: unknown;\n    };\n    Positional: unknown[];\n  };\n}\n\nexport default class DropdownTriggerModifier extends Modifier<Signature> {\n  didSetup = false;\n\n  triggerElement: HTMLElement | undefined;\n\n  toggleIsBeingHandledByTouchEvents: boolean = false;\n  touchMoveEvent: TouchEvent | undefined;\n\n  dropdown?: Dropdown;\n  desiredEventType!: string;\n  stopPropagation: boolean | undefined;\n\n  constructor(owner: Owner, args: ArgsFor<Signature>) {\n    super(owner, args);\n    registerDestructor(this, cleanup);\n  }\n\n  override modify(\n    element: HTMLElement,\n    positional: PositionalArgs<Signature>,\n    named: NamedArgs<Signature>,\n  ): void {\n    assert('must be provided dropdown object', named.dropdown);\n    this.dropdown = named.dropdown;\n    this.desiredEventType = named.eventType ?? 'click';\n    this.stopPropagation = named.stopPropagation;\n\n    if (!this.didSetup) {\n      this.setup(element);\n      this.didSetup = true;\n    }\n    this.update(element, positional, named);\n  }\n\n  setup(element: HTMLElement) {\n    // Keep a reference to the element for cleanup\n    this.triggerElement = element;\n    if (this.dropdown?.actions?.registerTriggerElement) {\n      this.dropdown.actions.registerTriggerElement(element);\n    }\n\n    if (!element.getAttribute('role')) element.setAttribute('role', 'button');\n\n    element.addEventListener('click', this.handleMouseEvent);\n    element.addEventListener('mousedown', this.handleMouseEvent);\n    element.addEventListener('keydown', this.handleKeyDown);\n    element.addEventListener('touchstart', this.handleTouchStart, {\n      passive: false,\n    });\n    element.addEventListener('touchend', this.handleTouchEnd);\n  }\n\n  update(\n    element: HTMLElement,\n    _positional: PositionalArgs<Signature>,\n    named: NamedArgs<Signature>,\n  ) {\n    const { dropdown } = named;\n\n    element.setAttribute('data-ebd-id', `${dropdown.uniqueId}-trigger`);\n\n    if (element.getAttribute('aria-owns') === null) {\n      element.setAttribute(\n        'aria-owns',\n        `ember-basic-dropdown-content-${dropdown.uniqueId}`,\n      );\n    }\n\n    if (element.getAttribute('aria-controls') === null) {\n      element.setAttribute(\n        'aria-controls',\n        `ember-basic-dropdown-content-${dropdown.uniqueId}`,\n      );\n    }\n\n    element.setAttribute('aria-expanded', dropdown.isOpen ? 'true' : 'false');\n    element.setAttribute('aria-disabled', dropdown.disabled ? 'true' : 'false');\n  }\n\n  @action\n  handleMouseEvent(e: MouseEvent): void {\n    if (typeof document === 'undefined') return;\n    const { dropdown, desiredEventType, stopPropagation } = this;\n\n    if (isDestroyed(this) || !dropdown || dropdown.disabled) return;\n\n    const eventType = e.type;\n    const notLeftClick = e.button !== 0;\n    if (eventType !== desiredEventType || notLeftClick) return;\n\n    if (stopPropagation) e.stopPropagation();\n\n    if (this.toggleIsBeingHandledByTouchEvents) {\n      // Some devises have both touchscreen & mouse, and they are not mutually exclusive\n      // In those cases the touchdown handler is fired first, and it sets a flag to\n      // short-circuit the mouseup so the component is not opened and immediately closed.\n      this.toggleIsBeingHandledByTouchEvents = false;\n      return;\n    }\n    dropdown.actions.toggle(e);\n  }\n\n  @action\n  handleKeyDown(e: KeyboardEvent): void {\n    const disabled = this.dropdown?.disabled,\n      actions = this.dropdown?.actions;\n\n    if (disabled || !actions) return;\n    if (e.keyCode === 13) {\n      // Enter\n      actions.toggle(e);\n    } else if (e.keyCode === 32) {\n      // Space\n      e.preventDefault(); // prevents the space to trigger a scroll page-next\n      actions.toggle(e);\n    } else if (e.keyCode === 27) {\n      actions.close(e);\n    }\n  }\n\n  @action\n  handleTouchStart(): void {\n    document.addEventListener('touchmove', this._touchMoveHandler);\n    if (this.triggerElement?.getRootNode() instanceof ShadowRoot) {\n      (this.triggerElement?.getRootNode() as HTMLElement).addEventListener(\n        'touchmove',\n        this._touchMoveHandler,\n      );\n    }\n  }\n\n  @action\n  handleTouchEnd(e: TouchEvent): void {\n    this.toggleIsBeingHandledByTouchEvents = true;\n    const disabled = this.dropdown?.disabled,\n      actions = this.dropdown?.actions;\n\n    if ((e && e.defaultPrevented) || disabled || !actions) {\n      return;\n    }\n    if (!hasMoved(e, this.touchMoveEvent)) {\n      actions.toggle(e);\n    }\n    this.touchMoveEvent = undefined;\n    document.removeEventListener('touchmove', this._touchMoveHandler);\n    // This next three lines are stolen from hammertime. This prevents the default\n    // behaviour of the touchend, but synthetically trigger a focus and a (delayed) click\n    // to simulate natural behaviour.\n    const target = (e.composedPath?.()[0] || e.target) as HTMLElement;\n    if (target !== null) {\n      target.focus();\n    }\n    setTimeout(function () {\n      if (!e.target) {\n        return;\n      }\n      try {\n        const event = document.createEvent('MouseEvents');\n        event.initMouseEvent(\n          'click',\n          true,\n          true,\n          window,\n          0,\n          0,\n          0,\n          0,\n          0,\n          false,\n          false,\n          false,\n          false,\n          0,\n          null,\n        );\n        e.target.dispatchEvent(event);\n      } catch {\n        const event = new Event('click');\n        e.target.dispatchEvent(event);\n      }\n    }, 0);\n    e.preventDefault();\n  }\n\n  @action\n  _touchMoveHandler(e: TouchEvent): void {\n    this.touchMoveEvent = e;\n    document.removeEventListener('touchmove', this._touchMoveHandler);\n\n    if (this.triggerElement?.getRootNode() instanceof ShadowRoot) {\n      (this.triggerElement?.getRootNode() as HTMLElement).removeEventListener(\n        'touchmove',\n        this._touchMoveHandler,\n      );\n    }\n  }\n}\n\nfunction cleanup(instance: DropdownTriggerModifier) {\n  const { triggerElement } = instance;\n  if (triggerElement) {\n    if (typeof document !== 'undefined')\n      document.removeEventListener('touchmove', instance._touchMoveHandler);\n\n    if (triggerElement?.getRootNode() instanceof ShadowRoot) {\n      (triggerElement?.getRootNode() as HTMLElement).removeEventListener(\n        'touchmove',\n        instance._touchMoveHandler,\n      );\n    }\n\n    triggerElement.removeEventListener('click', instance.handleMouseEvent);\n    triggerElement.removeEventListener('mousedown', instance.handleMouseEvent);\n    triggerElement.removeEventListener('keydown', instance.handleKeyDown);\n    triggerElement.removeEventListener('touchstart', instance.handleTouchStart);\n    triggerElement.removeEventListener('touchend', instance.handleTouchEnd);\n  }\n}\n"],"names":["DropdownTriggerModifier","Modifier","didSetup","triggerElement","toggleIsBeingHandledByTouchEvents","touchMoveEvent","dropdown","desiredEventType","stopPropagation","constructor","owner","args","registerDestructor","cleanup","modify","element","positional","named","assert","eventType","setup","update","actions","registerTriggerElement","getAttribute","setAttribute","addEventListener","handleMouseEvent","handleKeyDown","handleTouchStart","passive","handleTouchEnd","_positional","uniqueId","isOpen","disabled","e","document","isDestroyed","type","notLeftClick","button","toggle","n","prototype","action","keyCode","preventDefault","close","_touchMoveHandler","getRootNode","ShadowRoot","defaultPrevented","hasMoved","undefined","removeEventListener","target","composedPath","focus","setTimeout","event","createEvent","initMouseEvent","window","dispatchEvent","Event","instance"],"mappings":"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"}